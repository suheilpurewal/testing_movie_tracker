{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title text-center mb-4">Request a Movie</h3>

                    {% if message %}
                    <div class="alert alert-warning" role="alert">
                        {{ message }}
                    </div>
                    {% endif %}

                    <form action="/request_movie" method="POST">
                        <div class="form-group position-relative">
                            <label for="movie_title">Movie Title:</label>
                            <input type="text" id="movie_title" name="movie_title" class="form-control" required autocomplete="off">
                            <div id="suggestion-list" class="suggestion-list"></div>
                        </div>

                        <div class="form-group">
                            <label for="requested_by">Requested By:</label>
                            <select name="requested_by" id="requested_by" class="form-control" required>
                                <option value="" disabled selected>Select your name</option>
                                {% for user in users %}
                                <option value="{{ user.name }}">{{ user.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="d-flex justify-content-center">
                            <button type="submit" class="btn btn-primary btn-lg mt-3">Submit Request</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for autocomplete -->
<script>
    const apiKey = '0be927d50945d1293a82faa8e65bbdf8'; // Replace with your actual TMDb API key

    document.getElementById('movie_title').addEventListener('input', function () {
        const query = this.value;
        if (query.length > 2) {  // Trigger search if query is longer than 2 characters
            fetch(`https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    const suggestions = data.results.map(movie => ({
                        title: movie.title,
                        year: movie.release_date ? movie.release_date.split('-')[0] : 'N/A'
                    }));
                    displaySuggestions(suggestions);
                })
                .catch(error => console.error('Error fetching movie suggestions:', error));
        } else {
            document.getElementById('suggestion-list').innerHTML = '';
        }
    });

    function displaySuggestions(suggestions) {
        const suggestionList = document.getElementById('suggestion-list');
        suggestionList.innerHTML = '';
        suggestions.forEach(suggestion => {
            const listItem = document.createElement('div');
            listItem.classList.add('suggestion-item');
            listItem.textContent = `${suggestion.title} (${suggestion.year})`;
            listItem.addEventListener('click', function () {
                document.getElementById('movie_title').value = suggestion.title;
                suggestionList.innerHTML = '';
            });
            suggestionList.appendChild(listItem);
        });
    }
</script>

<!-- CSS for styling the suggestion box -->
<style>
    .position-relative {
        position: relative;
    }
    .suggestion-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-top: none;
    }
    .suggestion-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #ddd;
    }
    .suggestion-item:hover {
        background-color: #f0f0f0;
    }
</style>
{% endblock %}
